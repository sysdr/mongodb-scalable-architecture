# Implementation Guide — Day 3: TCMalloc Hardware Alignment Demo

This project demonstrates **MongoDB built with TCMalloc** by running MongoDB (official image or from-source build), a demo workload, and a dashboard that shows `serverStatus().tcmalloc` and opcounters. Follow these steps to run it.

---

## Prerequisites

- **Docker** (recommended) — For the fast path: no build, uses the official `mongo:7.0` image. Install [Docker](https://docs.docker.com/get-docker/) and ensure the daemon is running.
- **Optional (host build):** For building MongoDB from source with TCMalloc: `build-essential`, `libssl-dev`, `libcurl4-openssl-dev`, `libgoogle-perftools-dev`, `python3`, `python3-dev`, `scons`, `git`. Install with:  
  `sudo apt-get install -y build-essential libssl-dev libcurl4-openssl-dev libgoogle-perftools-dev python3 python3-dev python3-pip git`
- **Optional:** `mongosh` or `mongo` on the host to query MongoDB from the host (not required when using Docker; the container has `mongosh`).

---

## Project layout

```
day3/
├── setup.sh           # Full setup: start MongoDB, run workload, run dashboard
├── start.sh           # Start MongoDB only (Docker or host)
├── stop.sh            # Stop MongoDB (container and/or host process)
├── demo.sh            # Insert demo data; refresh dashboard metrics
├── run_tests.sh       # Verify setup, no duplicate services, TCMalloc and metrics
├── README.md          # Script summary and usage
├── IMPLEMENTATION_GUIDE.md   # This file
├── data/              # Created at runtime (MongoDB data; do not check in)
├── log/               # Created at runtime (mongod log)
└── Dockerfile         # Generated by setup.sh --docker (host build path only)
```

---

## Step 1: Open the project directory

From a terminal:

```bash
cd /path/to/mongodb-scalable-architecture/day3
```

Or use the full path to scripts (e.g. `/path/to/day3/start.sh`).

---

## Step 2: Make scripts executable (first time only)

```bash
chmod +x setup.sh start.sh stop.sh demo.sh run_tests.sh
```

---

## Step 3: Choose run mode

**Option A — Docker (recommended, no build)**  
Uses the official MongoDB image; no clone or compile.

**Option B — Host**  
Builds MongoDB from source with TCMalloc (long build, requires dependencies).

---

## Step 4: Run setup (first time)

**Docker (fast):**

```bash
./setup.sh --docker
```

This will:

1. Start MongoDB in a Docker container (`mongo:7.0`).
2. Verify TCMalloc via `serverStatus().tcmalloc`.
3. Run a test workload (insert 10,000 documents).
4. Run the TCMalloc dashboard for ~15 seconds (tcmalloc + opcounters every 5 s).
5. Exit (cleanup stops host mongod if any; the Docker container stays running).

**Host (from-source build):**

```bash
./setup.sh
```

This will install dependencies (if needed), clone MongoDB source, build with TCMalloc, start mongod, run the workload, and the dashboard. The build can take a long time.

---

## Step 5: Start MongoDB only (after setup)

If MongoDB is not running (e.g. after a reboot or you ran `./stop.sh`):

```bash
./start.sh
```

- If you used **Docker** before: starts the same container or creates a new one with `mongo:7.0`.
- If you used **host** before: starts `mongod` from `mongodb-build/install/bin/mongod`.
- If a container or process is already running on port 27017, the script does nothing and exits successfully.

---

## Step 6: Run the demo (populate metrics)

To insert demo data and refresh metrics (so the dashboard shows non-zero values):

```bash
./demo.sh
```

You should see:

- `[SUCCESS] Inserted 10000 documents into testcollection.`
- `tcmalloc: present`
- `opcounters` and `connections.current` printed.

---

## Step 7: Run the dashboard (optional)

The dashboard runs automatically at the end of `setup.sh`. To see metrics again without re-running setup:

- Run `./demo.sh` (to refresh data), then use `mongosh` or `mongo` to run:

  ```javascript
  db.serverStatus().tcmalloc
  db.serverStatus().opcounters
  db.serverStatus().connections
  ```

- Or run `./setup.sh --docker` again (it will start the container, run workload, and show the dashboard).

---

## Step 8: Run tests

To verify generated files, no duplicate services, MongoDB reachable, and TCMalloc/demo metrics:

```bash
./run_tests.sh
```

Expect sections like:

- **Generated files/directories** — present or (Docker) container running.
- **Duplicate services** — no duplicates.
- **MongoDB reachability** — reachable.
- **TCMalloc and demo metrics** — TCMalloc active, demo data present.

---

## Step 9: Stop MongoDB

When you are done:

```bash
./stop.sh
```

This stops the Docker container (if used) and any host `mongod` on port 27017.

---

## What you’ll see

- **Setup (Docker):** Container start, TCMalloc verification (JSON), “Inserted 10,000 documents”, then the **TCMalloc Dashboard** with `tcmalloc`, `opcounters`, and `connections` every 5 seconds.
- **Demo:** “Inserted 10000 documents into testcollection”, then `tcmalloc: present` and opcounters/connections.
- **Dashboard:** `serverStatus()` output including `tcmalloc` (heap, thread cache, page heap) and `opcounters` (insert, query, command, etc.). Values are non-zero after the demo workload.

---

## Troubleshooting

| Issue | What to do |
|-------|------------|
| “MongoDB binary not found” | You ran host-mode setup but the build failed or wasn’t run. Use `./setup.sh --docker` for the Docker path, or run `./setup.sh` (host) and wait for the build to finish. |
| “MongoDB not reachable” | Start MongoDB first: `./start.sh`. Wait a few seconds, then run `./demo.sh` or `./run_tests.sh`. |
| “Permission denied” on `data/` | Data was created by Docker (root). Clear it with the repo’s `./clear-data.sh` (uses Docker to clear) or `sudo rm -rf day3/data/*`. |
| Port 27017 in use | Stop the existing MongoDB: `./stop.sh`, or stop the process using port 27017. |
| Docker not available | Install Docker, or use host build: `./setup.sh` (requires build dependencies). |

---

## Quick reference

| Goal | Command |
|------|---------|
| First-time setup (Docker) | `./setup.sh --docker` |
| First-time setup (host build) | `./setup.sh` |
| Start MongoDB | `./start.sh` |
| Insert demo data / refresh metrics | `./demo.sh` |
| Run tests | `./run_tests.sh` |
| Stop MongoDB | `./stop.sh` |
